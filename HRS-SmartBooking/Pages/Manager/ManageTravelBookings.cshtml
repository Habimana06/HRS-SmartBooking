@page "/Manager/ManageTravelBookings"
@model HRS_SmartBooking.Pages.Manager.ManageTravelBookingsModel
@{
    ViewData["Title"] = "Manage Travel Bookings";
}

@Html.AntiForgeryToken()

<section class="reception-page manager-page">
    <header class="reception-header">
        <div>
            <p class="eyebrow">Travel & Attractions</p>
            <h1>Manage Travel Bookings</h1>
            <p>View, manage, and create travel bookings for attractions and experiences.</p>
        </div>
        <div class="header-actions">
            <a asp-page="/Manager/CreateTravelBooking" class="btn btn-gradient">
                <i class="bi bi-plus-circle me-2"></i>
                Create Travel Booking
            </a>
        </div>
    </header>

    <form method="get" class="filter-bar">
        <div class="filter-field">
            <label>Status</label>
            <select name="bookingStatus" asp-for="BookingStatus">
                <option value="">All</option>
                <option value="pending">Pending</option>
                <option value="confirmed">Confirmed</option>
                <option value="cancelled">Cancelled</option>
            </select>
        </div>
        <div class="filter-field">
            <label>Payment Status</label>
            <select name="paymentStatus" asp-for="PaymentStatus">
                <option value="">All</option>
                <option value="pending">Pending</option>
                <option value="paid">Paid</option>
                <option value="failed">Failed</option>
                <option value="refunded">Refunded</option>
            </select>
        </div>
        <div class="filter-field">
            <label>Refund Status</label>
            <select name="refundStatus" asp-for="RefundStatus">
                <option value="">All</option>
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="denied">Denied</option>
                <option value="processed">Processed</option>
            </select>
        </div>
        <div class="filter-field full">
            <label>Search</label>
            <div class="input-icon">
                <i class="bi bi-search"></i>
                <input type="search" name="searchQuery" asp-for="SearchQuery" placeholder="Search by customer name, attraction, or booking ID" />
            </div>
        </div>
        <button type="submit" class="btn btn-outline-light">Filter</button>
        @if (!string.IsNullOrEmpty(Model.BookingStatus) || !string.IsNullOrEmpty(Model.PaymentStatus) || !string.IsNullOrEmpty(Model.RefundStatus) || !string.IsNullOrEmpty(Model.SearchQuery))
        {
            <a asp-page="/Manager/ManageTravelBookings" class="btn btn-outline-light">Clear</a>
        }
    </form>

    <div class="data-card table-card">
        <div class="card-header">
            <h2>Travel Bookings</h2>
            <span class="badge badge-outline">@Model.TravelBookings.Count entries</span>
        </div>
        <div class="responsive-table">
            <table>
                <thead>
                    <tr>
                        <th>Booking ID</th>
                        <th>Customer</th>
                        <th>Attraction</th>
                        <th>Type</th>
                        <th>Travel Date</th>
                        <th>Participants</th>
                        <th>Total Price</th>
                        <th>Payment Status</th>
                        <th>Booking Status</th>
                        <th>Refund Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var booking in Model.TravelBookings)
                    {
                        <tr>
                            <td><strong>TB-@booking.TravelBookingId</strong></td>
                            <td>@booking.CustomerName</td>
                            <td>@booking.AttractionName</td>
                            <td>@booking.AttractionType</td>
                            <td>@booking.TravelDate</td>
                            <td>@booking.NumberOfParticipants</td>
                            <td><strong>@booking.TotalPrice</strong></td>
                            <td>
                                <span class="status @booking.PaymentStatus.Replace(" ", "").ToLower()">@booking.PaymentStatus</span>
                            </td>
                            <td>
                                <span class="status @booking.BookingStatus.Replace(" ", "").ToLower()">@booking.BookingStatus</span>
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(booking.RefundStatus))
                                {
                                    <span class="status @booking.RefundStatus.Replace(" ", "").ToLower()">@booking.RefundStatus</span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td>@booking.CreatedAt</td>
                            <td>
                                <div class="action-buttons">
                                    <a asp-page="/Manager/CreateTravelBooking" asp-route-id="@booking.TravelBookingId" class="btn btn-sm btn-outline-light" title="Edit">
                                        <i class="bi bi-pencil"></i> Edit
                                    </a>
                                    <button class="btn btn-sm btn-danger" onclick="deleteBooking(@booking.TravelBookingId)" title="Delete">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                    @if (booking.RefundStatus == "pending")
                                    {
                                        <button class="btn btn-sm btn-gradient" onclick="approveRefund(@booking.TravelBookingId)">Approve</button>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        function viewDetails(id) {
            // Implement view details modal or redirect
            console.log('View details for travel booking:', id);
        }

        function approveRefund(id) {
            if (confirm('Are you sure you want to approve this refund?')) {
                fetch(`/Manager/ManageTravelBookings?handler=ApproveRefund&id=${id}`, {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    }
                }).then(() => location.reload());
            }
        }

        function deleteBooking(id) {
            if (confirm('Are you sure you want to delete this travel booking? This action cannot be undone.')) {
                fetch(`/Manager/ManageTravelBookings?handler=Delete&id=${id}`, {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    }
                }).then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Error deleting booking. Please try again.');
                    }
                });
            }
        }
    </script>
}

