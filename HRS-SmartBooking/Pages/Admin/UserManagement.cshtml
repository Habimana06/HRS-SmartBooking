@page "/Admin/UserManagement"
@model HRS_SmartBooking.Pages.Admin.UserManagementModel
@using HRS_SmartBooking.Helpers
@{
    ViewData["Title"] = "User Management";
    var lang = TranslationHelper.GetCurrentLanguage(HttpContext);
}
@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Handle form submission and modal behavior
        document.addEventListener('DOMContentLoaded', function() {
            var addUserForm = document.getElementById('addUserForm');
            var addUserModal = document.getElementById('addUserModal');
            
            if (addUserForm && addUserModal) {
                // On form submit, prevent default if validation fails
                addUserForm.addEventListener('submit', function(e) {
                    if (!addUserForm.checkValidity()) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                    addUserForm.classList.add('was-validated');
                });

                // If there's a success message, close modal and reload after a delay
                @if (!string.IsNullOrEmpty(Model.SuccessMessage))
                {
                    <text>
                    var modal = bootstrap.Modal.getInstance(addUserModal);
                    if (modal) {
                        setTimeout(function() {
                            modal.hide();
                            // Reload page to show new user in the list
                            window.location.reload();
                        }, 1500);
                    }
                    </text>
                }
                
                // If there's an error, keep modal open
                @if (!string.IsNullOrEmpty(Model.ErrorMessage))
                {
                    <text>
                    var modal = bootstrap.Modal.getInstance(addUserModal);
                    if (!modal) {
                        var bsModal = new bootstrap.Modal(addUserModal);
                        bsModal.show();
                    }
                    </text>
                }

                // Reset form when modal is hidden
                addUserModal.addEventListener('hidden.bs.modal', function() {
                    addUserForm.reset();
                    addUserForm.classList.remove('was-validated');
                    // Clear any error/success messages
                    var alerts = addUserModal.querySelectorAll('.alert');
                    alerts.forEach(function(alert) {
                        alert.remove();
                    });
                });
            }
        });
    </script>
}

<section class="reception-page admin-page">
    <header class="reception-header">
        <div>
            <p class="eyebrow">Users</p>
            <h1>@TranslationHelper.T("User Management", lang)</h1>
            <p>Full control over accounts, roles, status, and bulk operations.</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-outline-light">Bulk assign role</button>
            <button class="btn btn-gradient" data-bs-toggle="modal" data-bs-target="#addUserModal">
                <i class="bi bi-person-plus me-2"></i>
                @TranslationHelper.T("Add user", lang)
            </button>
        </div>
    </header>

    <form class="filter-bar">
        <div class="filter-field">
            <label>Role</label>
            <select>
                <option>All</option>
                <option>Admin</option>
                <option>Manager</option>
                <option>Receptionist</option>
                <option>Technician</option>
            </select>
        </div>
        <div class="filter-field">
            <label>Status</label>
            <select>
                <option>All</option>
                <option>Active</option>
                <option>Suspended</option>
            </select>
        </div>
        <div class="filter-field full">
            <label>Search</label>
            <div class="input-icon">
                <i class="bi bi-search"></i>
                <input type="search" placeholder="Name, username, or email" />
            </div>
        </div>
        <button class="btn btn-outline-light" type="button">Filter</button>
    </form>

    <div class="data-card table-card">
        <div class="card-header">
            <h2>Users table</h2>
            <span class="badge badge-outline">@Model.Users.Count users</span>
        </div>
        <div class="responsive-table">
            <table>
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" />
                        </th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Last login</th>
                        <th>Created</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in Model.Users)
                    {
                        <tr>
                            <td><input type="checkbox" /></td>
                            <td>@user.Name</td>
                            <td>@user.Email</td>
                            <td>@user.Role</td>
                            <td><span class="status">@user.Status</span></td>
                            <td>@user.LastLogin</td>
                            <td>@user.Created</td>
                            <td class="actions">
                                <button class="btn btn-icon btn-compact" title="View">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-icon btn-compact" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-icon btn-compact" title="Disable">
                                    <i class="bi bi-slash-circle"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

</section>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                @if (!string.IsNullOrEmpty(Model.SuccessMessage))
                {
                    <div class="alert alert-success" role="alert">
                        @Model.SuccessMessage
                    </div>
                }
                @if (!string.IsNullOrEmpty(Model.ErrorMessage))
                {
                    <div class="alert alert-danger" role="alert">
                        @Model.ErrorMessage
                    </div>
                }
                <form method="post" asp-page-handler="CreateUser" id="addUserForm">
                    <div asp-validation-summary="All" class="text-danger mb-3"></div>
                    <div class="form-grid">
                        <div>
                            <label asp-for="CreateUserInput.FullName">Full name</label>
                            <input asp-for="CreateUserInput.FullName" type="text" placeholder="Full name" required />
                            <span asp-validation-for="CreateUserInput.FullName" class="text-danger"></span>
                        </div>
                        <div>
                            <label asp-for="CreateUserInput.Email">Email</label>
                            <input asp-for="CreateUserInput.Email" type="email" placeholder="email@domain.com" required />
                            <span asp-validation-for="CreateUserInput.Email" class="text-danger"></span>
                        </div>
                        <div>
                            <label asp-for="CreateUserInput.Phone">Phone</label>
                            <input asp-for="CreateUserInput.Phone" type="tel" placeholder="+1 555 0101" />
                            <span asp-validation-for="CreateUserInput.Phone" class="text-danger"></span>
                        </div>
                        <div>
                            <label asp-for="CreateUserInput.Password">Password</label>
                            <input asp-for="CreateUserInput.Password" type="password" placeholder="••••••••" required minlength="6" />
                            <small class="muted">Minimum 6 characters</small>
                            <span asp-validation-for="CreateUserInput.Password" class="text-danger"></span>
                        </div>
                        <div>
                            <label asp-for="CreateUserInput.Role">Role</label>
                            <select asp-for="CreateUserInput.Role" required>
                                <option value="Customer">Customer</option>
                                <option value="Receptionist">Receptionist</option>
                                <option value="Manager">Manager</option>
                                <option value="Admin">Admin</option>
                            </select>
                            <span asp-validation-for="CreateUserInput.Role" class="text-danger"></span>
                        </div>
                        <div>
                            <label asp-for="CreateUserInput.Status">Status</label>
                            <select asp-for="CreateUserInput.Status" required>
                                <option value="Active">Active</option>
                                <option value="Suspended">Suspended</option>
                            </select>
                            <span asp-validation-for="CreateUserInput.Status" class="text-danger"></span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="addUserForm" class="btn btn-gradient">Create user</button>
            </div>
        </div>
    </div>
</div>

