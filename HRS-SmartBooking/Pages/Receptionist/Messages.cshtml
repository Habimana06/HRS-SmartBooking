@page "/Receptionist/Messages"
@model HRS_SmartBooking.Pages.Receptionist.MessagesModel
@{
    ViewData["Title"] = "Messages & Chats";
}

<section class="reception-page chat-page">
    <header class="reception-header">
        <div>
            <p class="eyebrow">Messaging</p>
            <h1>Conversation hub</h1>
            <p>Customer & internal chats with quick replies, read receipts, and status dots.</p>
        </div>
        <button class="btn btn-gradient">
            <i class="bi bi-pencil-square me-2"></i>
            New conversation
        </button>
    </header>

    <div class="chat-shell">
        <aside class="chat-sidebar">
            <div class="input-icon mb-3">
                <i class="bi bi-search"></i>
                <input type="search" placeholder="Search conversations" />
            </div>
            <ul class="conversation-list">
                @foreach (var convo in Model.Conversations)
                {
                    <li class="conversation-item @(Model.SelectedCustomerId == convo.CustomerId ? "active" : "") @(convo.HasUnread ? "has-unread" : "")" 
                        onclick="location.href='?customerId=@convo.CustomerId'" style="cursor: pointer;">
                        <div>
                            <strong>@convo.Title</strong>
                            <p>@convo.Snippet</p>
                            <small>@convo.LastMessageTime.ToString("MMM dd, HH:mm")</small>
                        </div>
                        @if (convo.HasUnread)
                        {
                            <span class="badge badge-outline" style="background: #ef4444; color: white;">New</span>
                        }
                        else
                        {
                            <span class="badge badge-outline">Customer</span>
                        }
                    </li>
                }
            </ul>
        </aside>

        <article class="chat-window">
            @if (Model.SelectedCustomerId.HasValue && Model.SelectedCustomerId.Value > 0)
            {
                var customer = Model.Conversations.FirstOrDefault(c => c.CustomerId == Model.SelectedCustomerId.Value);
                <header class="chat-header">
                    <div>
                        <strong>@(customer?.Title ?? "Customer")</strong>
                        <p>Customer Conversation</p>
                    </div>
                </header>
                <div class="chat-messages" id="receptionistChatMessages">
                    @foreach (var bubble in Model.Chat)
                    {
                        <div class="chat-bubble @(bubble.IsAgent ? "agent" : "guest")">
                            <small>@bubble.Sender • @bubble.CreatedAt.ToString("MMM dd, HH:mm")</small>
                            <p>@bubble.Body</p>
                        </div>
                    }
                </div>
                <div class="chat-input">
                    <div class="chat-input-wrapper">
                        <div class="input-icon">
                            <i class="bi bi-chat-dots"></i>
                            <input type="text" id="receptionistMessageInput" placeholder="Type a reply..." 
                                   data-customer-id="@Model.SelectedCustomerId.Value" 
                                   autocomplete="off" />
                        </div>
                        <button type="button" id="receptionistSendBtn" class="btn btn-gradient chat-send-btn" title="Send message">
                            <i class="bi bi-send"></i>
                            <span class="btn-text">Send</span>
                        </button>
                    </div>
                    <div id="receptionistErrorMsg" class="chat-error-message" style="display: none;"></div>
                </div>
            }
            else
            {
                <header class="chat-header">
                    <div>
                        <strong>Select a conversation</strong>
                        <p>Choose a customer from the list to view messages</p>
                    </div>
                </header>
                <div class="chat-messages">
                    <div class="chat-bubble agent">
                        <p>No conversation selected. Please select a customer from the sidebar.</p>
                    </div>
                </div>
            }
        </article>
    </div>
</section>

@section Scripts {
    <script>
        (function() {
            const messageInput = document.getElementById('receptionistMessageInput');
            const sendBtn = document.getElementById('receptionistSendBtn');
            const chatMessages = document.getElementById('receptionistChatMessages');
            const errorMsg = document.getElementById('receptionistErrorMsg');
            
            if (!messageInput || !sendBtn || !chatMessages) return;
            
            let isLoading = false;
            let refreshInterval = null;
            
            function showError(message) {
                if (errorMsg) {
                    errorMsg.textContent = message;
                    errorMsg.style.display = 'block';
                    setTimeout(() => {
                        errorMsg.style.display = 'none';
                    }, 5000);
                }
            }
            
            function addMessageToChat(messageText, isReceptionist, senderName) {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                const dateStr = now.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric'
                });
                
                const messageHtml = `
                    <div class="chat-bubble ${isReceptionist ? 'agent' : 'guest'}">
                        <small>${senderName} • ${dateStr}, ${timeStr}</small>
                        <p>${escapeHtml(messageText)}</p>
                    </div>
                `;
                
                chatMessages.insertAdjacentHTML('beforeend', messageHtml);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            function sendMessage() {
                const message = messageInput.value.trim();
                const customerId = messageInput.dataset.customerId;
                
                if (!message || !customerId) {
                    if (!message) {
                        showError('Please enter a message');
                    }
                    return;
                }
                
                if (isLoading) return;
                
                isLoading = true;
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> <span class="btn-text">Sending...</span>';
                
                fetch('/Receptionist/ChatApi?handler=SendReply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ 
                        customerId: parseInt(customerId),
                        message: message 
                    })
                })
                .then(async response => {
                    let data;
                    try {
                        data = await response.json();
                    } catch (e) {
                        throw new Error('Invalid response from server');
                    }
                    if (!response.ok) {
                        throw new Error(data.error || `Server error: ${response.status}`);
                    }
                    return data;
                })
                .then(data => {
                    if (data.success) {
                        messageInput.value = '';
                        // Add message to chat immediately
                        const customerName = document.querySelector('.chat-header strong')?.textContent || 'You';
                        addMessageToChat(message, true, 'You');
                    } else {
                        throw new Error(data.error || 'Failed to send message');
                    }
                })
                .catch(error => {
                    console.error('Error sending message:', error);
                    showError(error.message || 'Error sending message. Please try again.');
                })
                .finally(() => {
                    isLoading = false;
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = '<i class="bi bi-send"></i> <span class="btn-text">Send</span>';
                });
            }
            
            sendBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Auto-refresh messages every 3 seconds (check for new customer messages)
            function refreshMessages() {
                if (!messageInput.dataset.customerId || isLoading) return;
                
                fetch(`/Receptionist/ChatApi?handler=CustomerMessages&customerId=${messageInput.dataset.customerId}`)
                    .then(async response => {
                        if (!response.ok) return;
                        return response.json();
                    })
                    .then(messages => {
                        if (Array.isArray(messages) && messages.length > 0) {
                            // Check if we have new messages
                            const currentMessageCount = chatMessages.querySelectorAll('.chat-bubble').length;
                            if (messages.length > currentMessageCount) {
                                // Reload to show new messages
                                location.reload();
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error refreshing messages:', error);
                    });
            }
            
            if (messageInput.dataset.customerId) {
                refreshInterval = setInterval(refreshMessages, 3000);
            }
            
            // Clean up on page unload
            window.addEventListener('beforeunload', () => {
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                }
            });
        })();
    </script>
}

