@page "/Customer/Booking"
@model HRS_SmartBooking.Pages.Customer.BookingModel
@{
    ViewData["Title"] = "Booking";
}

<section class="customer-section booking-flow">
    <div class="section-header">
        <div>
            <p class="eyebrow">Booking</p>
            <h1>Three-step premium booking flow</h1>
            <p>Date picker, guest info, cost summary, payment inputs, promo code, and confirmation pop.</p>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
    {
        <div class="alert alert-success" role="alert">
            <i class="bi bi-check-circle me-2"></i>@Model.SuccessMessage
        </div>
    }

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger" role="alert">
            <i class="bi bi-exclamation-circle me-2"></i>@Model.ErrorMessage
        </div>
    }

    @if (!string.IsNullOrEmpty(Model.Attraction))
    {
        <!-- Travel Booking Form -->
        <form method="post" asp-page-handler="TravelBooking" class="booking-grid" id="travelBookingForm">
            <div class="glass-panel">
                <h2>Travel Booking Details</h2>
                <div class="form-grid">
                    <div class="col-span-2">
                        <label>Attraction</label>
                        <input type="text" value="@Model.Attraction" readonly />
                        <input type="hidden" asp-for="TravelInput.AttractionName" value="@Model.Attraction" />
                        <input type="hidden" asp-for="TravelInput.AttractionType" value="@Model.Type" />
                    </div>
                    <div>
                        <label>Travel Date</label>
                        <input type="date" asp-for="TravelInput.TravelDate" min="@DateTime.Today.ToString("yyyy-MM-dd")" required />
                        <span asp-validation-for="TravelInput.TravelDate" class="text-danger"></span>
                    </div>
                    <div>
                        <label>Number of Participants</label>
                        <input type="number" asp-for="TravelInput.NumberOfParticipants" min="1" max="20" value="2" required />
                        <span asp-validation-for="TravelInput.NumberOfParticipants" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <div class="glass-panel">
                <h2>Payment</h2>
                <div class="form-grid">
                    <div class="col-span-2">
                        <label>Payment Method</label>
                        <select asp-for="TravelInput.PaymentMethod" id="travelPaymentMethodSelect" required>
                            <option value="">Select payment method</option>
                            <option value="Card">Credit/Debit Card</option>
                            <option value="MTN MoMo">MTN Mobile Money</option>
                        </select>
                        <span asp-validation-for="TravelInput.PaymentMethod" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <div class="glass-panel">
                <h2>Cost Summary</h2>
                <div class="cost-summary">
                    <div class="cost-item">
                        <span>Base Price per Person</span>
                        <span id="travelBasePrice">@(Model.Type == "Nature" ? "RWF 180,000" : Model.Type == "Adventure" ? "RWF 96,000" : Model.Type == "Wildlife" ? "RWF 144,000" : Model.Type == "Culture" ? "RWF 60,000" : "RWF 120,000")</span>
                    </div>
                    <div class="cost-item">
                        <span>Participants</span>
                        <span id="travelParticipants">2</span>
                    </div>
                    <div class="cost-total">
                        <span>Total</span>
                        <span id="travelTotalPrice">@(Model.Type == "Nature" ? "RWF 360,000" : Model.Type == "Adventure" ? "RWF 192,000" : Model.Type == "Wildlife" ? "RWF 288,000" : Model.Type == "Culture" ? "RWF 120,000" : "RWF 240,000")</span>
                    </div>
                </div>
                <button type="submit" class="btn btn-gradient w-100 mt-3">
                    <i class="bi bi-calendar-check"></i> Confirm Travel Booking
                </button>
            </div>
        </form>
    }
    else
    {
        <!-- Room Booking Form -->
        <form method="post" class="booking-grid" id="bookingForm">
        <div class="glass-panel">
            <h2>Stay details</h2>
            <div class="form-grid">
                <div>
                    <label>Check-in</label>
                    @{
                        var checkInValue = Model.Input.CheckInDate == default(DateTime) || Model.Input.CheckInDate < new DateTime(2001, 1, 1) 
                            ? DateTime.Today.ToString("yyyy-MM-dd") 
                            : Model.Input.CheckInDate.ToString("yyyy-MM-dd");
                        var checkOutValue = Model.Input.CheckOutDate == default(DateTime) || Model.Input.CheckOutDate < new DateTime(2001, 1, 1)
                            ? DateTime.Today.AddDays(1).ToString("yyyy-MM-dd")
                            : Model.Input.CheckOutDate.ToString("yyyy-MM-dd");
                    }
                    <input type="date" asp-for="Input.CheckInDate" value="@checkInValue" min="2001-01-01" max="@DateTime.Now.AddYears(10).ToString("yyyy-MM-dd")" required />
                    <span asp-validation-for="Input.CheckInDate" class="text-danger"></span>
                </div>
                <div>
                    <label>Check-out</label>
                    <input type="date" asp-for="Input.CheckOutDate" value="@checkOutValue" min="2001-01-01" max="@DateTime.Now.AddYears(10).ToString("yyyy-MM-dd")" required />
                    <span asp-validation-for="Input.CheckOutDate" class="text-danger"></span>
                </div>
                <div>
                    <label>Guests</label>
                    <input type="number" asp-for="Input.NumberOfGuests" min="1" max="10" value="2" required />
                    <span asp-validation-for="Input.NumberOfGuests" class="text-danger"></span>
                </div>
                <div>
                    <label>Room</label>
                    <input type="hidden" asp-for="Input.RoomId" value="@Model.Input.RoomId" />
                    @if (Model.SelectedRoom != null)
                    {
                        <input type="text" value="@(Model.SelectedRoom.RoomType?.TypeName ?? "Room") @Model.SelectedRoom.RoomNumber" readonly />
                        <small class="text-muted">Room Type: @(Model.SelectedRoom.RoomType?.TypeName ?? "Standard")</small>
                    }
                    else if (Model.Input.RoomId > 0)
                    {
                        <input type="text" value="Room @Model.Input.RoomId" readonly />
                        <small class="text-danger">Room information not loaded. Please refresh the page.</small>
                    }
                    else
                    {
                        <input type="text" value="No room selected" readonly class="text-danger" />
                        <small class="text-danger">Please select a room from the rooms page first.</small>
                    }
                </div>
            </div>
        </div>

        <div class="glass-panel">
            <h2>Guest info</h2>
            <div class="form-grid">
                <div>
                    <label>First name</label>
                    <input type="text" value="@(ViewData["UserFirstName"] ?? "")" readonly />
                    <small class="text-muted">From your account</small>
                </div>
                <div>
                    <label>Last name</label>
                    <input type="text" value="@(ViewData["UserLastName"] ?? "")" readonly />
                    <small class="text-muted">From your account</small>
                </div>
                <div>
                    <label>Email</label>
                    <input type="email" value="@(ViewData["UserEmail"] ?? "")" readonly />
                    <small class="text-muted">From your account</small>
                </div>
                <div>
                    <label>Phone</label>
                    <input type="tel" value="@(ViewData["UserPhone"] ?? "")" readonly />
                    <small class="text-muted">From your account</small>
                </div>
            </div>
        </div>

        <div class="glass-panel">
            <h2>Payment</h2>
            <div class="form-grid">
                <div class="col-span-2">
                    <label>Payment Method</label>
                    <select asp-for="Input.PaymentMethod" id="paymentMethodSelect" required>
                        <option value="">Select payment method</option>
                        <option value="Card">Credit/Debit Card</option>
                        <option value="MTN MoMo">MTN Mobile Money</option>
                    </select>
                    <span asp-validation-for="Input.PaymentMethod" class="text-danger"></span>
                </div>
                
                <div id="cardPaymentFields" class="col-span-2" style="display: none;">
                    <div class="form-grid">
                        <div class="col-span-2">
                            <label>Card number</label>
                            <input type="text" asp-for="Input.CardNumber" placeholder="**** **** **** 2025" />
                        </div>
                        <div>
                            <label>Expiry</label>
                            <input type="text" asp-for="Input.CardExpiry" placeholder="09/28" />
                        </div>
                        <div>
                            <label>CVC</label>
                            <input type="text" asp-for="Input.CardCVC" placeholder="123" />
                        </div>
                    </div>
                </div>

                <div id="momoPaymentFields" class="col-span-2" style="display: none;">
                    <div class="form-grid">
                        <div class="col-span-2">
                            <label>MTN Mobile Money Number</label>
                            <input type="tel" asp-for="Input.MomoNumber" placeholder="0781234567" />
                            <small class="text-muted">Enter your MTN Mobile Money phone number</small>
                        </div>
                    </div>
                </div>

                <div class="col-span-2 promo-row">
                    <label>Promo code</label>
                    <div class="promo-input">
                        <input type="text" asp-for="Input.PromoCode" placeholder="LIMITLESS" />
                        <button type="button" class="btn btn-outline-light">Apply</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="glass-panel summary">
            <h2>Cost summary</h2>
            <ul>
                <li><span>Guests</span><strong>@Model.Input.NumberOfGuests guest(s)</strong></li>
                <li><span>Room</span><strong>@Model.RoomPrice</strong></li>
                <li><span>Taxes</span><strong>@Model.Taxes</strong></li>
                <li><span>Concierge</span><strong>@Model.ConciergeFee</strong></li>
            </ul>
            <div class="total">
                <span>Total</span>
                <strong>@Model.TotalPrice</strong>
            </div>
            <button type="submit" class="btn btn-gradient btn-lg w-100" id="confirmBookingBtn">
                <i class="bi bi-check2-circle me-2"></i>
                <span id="btnText">Confirm booking</span>
                <span id="btnSpinner" class="spinner-border spinner-border-sm d-none ms-2" role="status" aria-hidden="true"></span>
            </button>
            <p class="small text-muted mt-3">A confirmation pop will animate in to mimic final UX.</p>
        </div>
    </form>

    <div class="confirmation-pop hidden" id="bookingConfirm">
        <div class="pop-content">
            <i class="bi bi-check2-circle"></i>
            <h3>Booking request sent</h3>
            <p>We synced your stay details with concierge + wallet receipts.</p>
            <button class="btn btn-outline-light" data-close-confirm>Close</button>
        </div>
    </div>
    }
</section>

<!-- Travel Booking Section -->
<section class="customer-section">
    <div class="section-header">
        <div>
            <p class="eyebrow">Travel & Attractions</p>
            <h2>Book Your Rwanda Adventure</h2>
            <p>Explore Rwanda's amazing attractions and experiences</p>
        </div>
    </div>
    
    <div class="travel-booking-grid">
        <article class="travel-booking-card">
            <div class="travel-card-image" style="background-image: url('/images/forest3.jpg');">
                <div class="travel-card-badge">Nature</div>
            </div>
            <div class="travel-card-content">
                <h3>Volcanoes National Park</h3>
                <p>Gorilla trekking experience in their natural habitat</p>
                <div class="travel-card-meta">
                    <span><i class="bi bi-clock"></i> Full Day</span>
                    <span><i class="bi bi-people"></i> Guided</span>
                    <span class="travel-price">RWF 180,000/person</span>
                </div>
                <a asp-page="/Customer/Booking" asp-route-attraction="Volcanoes National Park" asp-route-type="Nature" class="btn btn-gradient w-100 mt-3">
                    <i class="bi bi-calendar-check"></i> Book Experience
                </a>
            </div>
        </article>

        <article class="travel-booking-card">
            <div class="travel-card-image" style="background-image: url('/images/forest5.jpg');">
                <div class="travel-card-badge">Adventure</div>
            </div>
            <div class="travel-card-content">
                <h3>Nyungwe Forest</h3>
                <p>Canopy walkway and chimpanzee tracking</p>
                <div class="travel-card-meta">
                    <span><i class="bi bi-clock"></i> Half Day</span>
                    <span><i class="bi bi-tree"></i> Rainforest</span>
                    <span class="travel-price">RWF 96,000/person</span>
                </div>
                <a asp-page="/Customer/Booking" asp-route-attraction="Nyungwe Forest" asp-route-type="Adventure" class="btn btn-gradient w-100 mt-3">
                    <i class="bi bi-calendar-check"></i> Book Experience
                </a>
            </div>
        </article>

        <article class="travel-booking-card">
            <div class="travel-card-image" style="background-image: url('/images/forest6.jpg');">
                <div class="travel-card-badge">Wildlife</div>
            </div>
            <div class="travel-card-content">
                <h3>Akagera National Park</h3>
                <p>Big Five safari experience</p>
                <div class="travel-card-meta">
                    <span><i class="bi bi-clock"></i> Full Day</span>
                    <span><i class="bi bi-camera"></i> Safari</span>
                    <span class="travel-price">RWF 144,000/person</span>
                </div>
                <a asp-page="/Customer/Booking" asp-route-attraction="Akagera National Park" asp-route-type="Wildlife" class="btn btn-gradient w-100 mt-3">
                    <i class="bi bi-calendar-check"></i> Book Experience
                </a>
            </div>
        </article>

        <article class="travel-booking-card">
            <div class="travel-card-image" style="background-image: url('/images/forest4.jpeg');">
                <div class="travel-card-badge">Culture</div>
            </div>
            <div class="travel-card-content">
                <h3>Cultural Tours</h3>
                <p>Traditional Rwandan culture and history</p>
                <div class="travel-card-meta">
                    <span><i class="bi bi-clock"></i> 3-4 Hours</span>
                    <span><i class="bi bi-people"></i> Interactive</span>
                    <span class="travel-price">RWF 60,000/person</span>
                </div>
                <a asp-page="/Customer/Booking" asp-route-attraction="Cultural Tours" asp-route-type="Culture" class="btn btn-gradient w-100 mt-3">
                    <i class="bi bi-calendar-check"></i> Book Experience
                </a>
            </div>
        </article>
    </div>
</section>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const paymentMethodSelect = document.getElementById('paymentMethodSelect');
            const cardFields = document.getElementById('cardPaymentFields');
            const momoFields = document.getElementById('momoPaymentFields');
            const checkInInput = document.querySelector('input[name="Input.CheckInDate"]');
            const checkOutInput = document.querySelector('input[name="Input.CheckOutDate"]');

            // Payment method toggle
            if (paymentMethodSelect) {
                paymentMethodSelect.addEventListener('change', function() {
                    if (this.value === 'Card') {
                        cardFields.style.display = 'block';
                        momoFields.style.display = 'none';
                    } else if (this.value === 'MTN MoMo') {
                        cardFields.style.display = 'none';
                        momoFields.style.display = 'block';
                    } else {
                        cardFields.style.display = 'none';
                        momoFields.style.display = 'none';
                    }
                });
            }

            // Form validation and loading state
            const bookingForm = document.getElementById('bookingForm');
            const confirmBtn = document.getElementById('confirmBookingBtn');
            const btnText = document.getElementById('btnText');
            const btnSpinner = document.getElementById('btnSpinner');

            if (bookingForm && confirmBtn) {
                bookingForm.addEventListener('submit', function(e) {
                    const paymentMethod = document.getElementById('paymentMethodSelect');
                    const roomIdInput = document.querySelector('input[name="Input.RoomId"]');
                    const checkInInput = document.querySelector('input[name="Input.CheckInDate"]');
                    const checkOutInput = document.querySelector('input[name="Input.CheckOutDate"]');
                    const guestsInput = document.querySelector('input[name="Input.NumberOfGuests"]');
                    
                    // Validate room selection
                    if (!roomIdInput || !roomIdInput.value || parseInt(roomIdInput.value) <= 0) {
                        e.preventDefault();
                        alert('Please select a room from the rooms page before booking.');
                        window.location.href = '/Customer/Rooms';
                        return false;
                    }
                    
                    // Validate payment method
                    if (!paymentMethod || !paymentMethod.value) {
                        e.preventDefault();
                        alert('Please select a payment method (Card or MTN MoMo) to continue.');
                        if (paymentMethod) {
                            paymentMethod.focus();
                            paymentMethod.style.borderColor = '#ef4444';
                        }
                        return false;
                    }
                    
                    // Validate dates
                    if (checkInInput && checkOutInput) {
                        const checkIn = new Date(checkInInput.value);
                        const checkOut = new Date(checkOutInput.value);
                        if (checkOut <= checkIn) {
                            e.preventDefault();
                            alert('Check-out date must be after check-in date.');
                            checkOutInput.focus();
                            return false;
                        }
                    }
                    
                    // Validate guests
                    if (guestsInput && (parseInt(guestsInput.value) < 1 || parseInt(guestsInput.value) > 10)) {
                        e.preventDefault();
                        alert('Number of guests must be between 1 and 10.');
                        guestsInput.focus();
                        return false;
                    }

                    // Show loading state
                    confirmBtn.disabled = true;
                    if (btnText) btnText.textContent = 'Processing...';
                    if (btnSpinner) btnSpinner.classList.remove('d-none');
                    
                    // Don't prevent default - allow form to submit
                });
            }

            // Recalculate prices when dates or guests change
            const guestsInput = document.querySelector('input[name="Input.NumberOfGuests"]');
            const roomIdInput = document.querySelector('input[name="Input.RoomId"]');
            
            async function recalculatePrice() {
                if (!roomIdInput || !checkInInput || !checkOutInput || !guestsInput) return;
                
                const roomId = parseInt(roomIdInput.value) || 0;
                const checkIn = checkInInput.value;
                const checkOut = checkOutInput.value;
                const guests = parseInt(guestsInput.value) || 2;
                
                if (!checkIn || !checkOut) return;
                
                try {
                    const response = await fetch(`/Customer/Booking?handler=RecalculatePrice&roomId=${roomId}&checkIn=${checkIn}&checkOut=${checkOut}&guests=${guests}`);
                    if (!response.ok) return;
                    
                    const data = await response.json();
                    
                    // Update the cost summary
                    const roomPriceEl = document.querySelector('.summary li:nth-child(2) strong');
                    const taxesEl = document.querySelector('.summary li:nth-child(3) strong');
                    const conciergeEl = document.querySelector('.summary li:nth-child(4) strong');
                    const totalEl = document.querySelector('.total strong');
                    const guestsEl = document.querySelector('.summary li:nth-child(1) strong');
                    
                    if (guestsEl) guestsEl.textContent = `${data.guests} guest(s)`;
                    if (roomPriceEl) {
                        roomPriceEl.textContent = data.roomPrice;
                        if (data.guestFee) {
                            roomPriceEl.textContent += ` + ${data.guestFee} (guest fee)`;
                        }
                    }
                    if (taxesEl) taxesEl.textContent = data.taxes;
                    if (conciergeEl) conciergeEl.textContent = data.conciergeFee;
                    if (totalEl) totalEl.textContent = data.totalPrice;
                } catch (error) {
                    console.error('Error recalculating price:', error);
                }
            }
            
            if (checkInInput && checkOutInput) {
                checkInInput.addEventListener('change', recalculatePrice);
                checkOutInput.addEventListener('change', recalculatePrice);
            }
            if (guestsInput) {
                guestsInput.addEventListener('change', recalculatePrice);
                guestsInput.addEventListener('input', recalculatePrice);
            }

            // Date validation: ensure check-out is after check-in
            if (checkInInput && checkOutInput) {
                // Fix invalid dates on page load
                const today = new Date().toISOString().split('T')[0];
                const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];
                
                if (!checkInInput.value || checkInInput.value < '2001-01-01') {
                    checkInInput.value = today;
                }
                if (!checkOutInput.value || checkOutInput.value < '2001-01-01') {
                    checkOutInput.value = tomorrow;
                }
                
                checkInInput.addEventListener('change', function() {
                    const checkInDate = new Date(this.value);
                    const minCheckOut = new Date(checkInDate);
                    minCheckOut.setDate(minCheckOut.getDate() + 1);
                    checkOutInput.min = minCheckOut.toISOString().split('T')[0];
                    
                    // If check-out is before or equal to check-in, update it
                    const checkOutDate = new Date(checkOutInput.value);
                    if (checkOutDate <= checkInDate) {
                        checkOutInput.value = minCheckOut.toISOString().split('T')[0];
                    }
                });

                checkOutInput.addEventListener('change', function() {
                    const checkInDate = new Date(checkInInput.value);
                    const checkOutDate = new Date(this.value);
                    if (checkOutDate <= checkInDate) {
                        const minCheckOut = new Date(checkInDate);
                        minCheckOut.setDate(minCheckOut.getDate() + 1);
                        this.value = minCheckOut.toISOString().split('T')[0];
                        alert('Check-out date must be after check-in date');
                    }
                });
            }
        });

        // Travel booking price calculation (all in RWF)
        const travelParticipantsInput = document.getElementById('TravelInput_NumberOfParticipants');
        if (travelParticipantsInput) {
            travelParticipantsInput.addEventListener('change', function() {
                const participants = parseInt(this.value) || 2;
                const attractionType = '@Model.Type';
                // Base prices in RWF (already converted)
                const basePriceRWF = attractionType === 'Nature' ? 180000 : 
                                 attractionType === 'Adventure' ? 96000 : 
                                 attractionType === 'Wildlife' ? 144000 : 
                                 attractionType === 'Culture' ? 60000 : 120000;
                const totalRWF = basePriceRWF * participants;
                
                const participantsEl = document.getElementById('travelParticipants');
                const basePriceEl = document.getElementById('travelBasePrice');
                const totalEl = document.getElementById('travelTotalPrice');
                
                if (participantsEl) participantsEl.textContent = participants;
                if (basePriceEl) basePriceEl.textContent = `RWF ${basePriceRWF.toLocaleString()}`;
                if (totalEl) totalEl.textContent = `RWF ${totalRWF.toLocaleString()}`;
            });
        }
    </script>
}

