@page "/Customer/MyBookings"
@model HRS_SmartBooking.Pages.Customer.MyBookingsModel
@{
    ViewData["Title"] = "My Bookings";
}

<section class="customer-section my-bookings-page">
    <div class="section-header">
        <div>
            <p class="eyebrow">My Bookings</p>
            <h1>Your reservation history</h1>
            <p>View all your bookings, download information, and access room keys and QR codes.</p>
        </div>
    </div>

    @if (TempData["BookingSuccess"] != null && (bool)TempData["BookingSuccess"])
    {
        <div class="alert alert-success" role="alert">
            <i class="bi bi-check-circle me-2"></i>Booking confirmed successfully! Your room has been reserved.
        </div>
    }

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger" role="alert">
            <i class="bi bi-exclamation-circle me-2"></i>@Model.ErrorMessage
        </div>
    }

    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
    {
        <div class="alert alert-success" role="alert">
            <i class="bi bi-check-circle me-2"></i>@Model.SuccessMessage
        </div>
    }

    @if (Model.Bookings.Any())
    {
        <div class="bookings-grid atm-cards-grid">
            @foreach (var booking in Model.Bookings)
            {
                <div class="atm-card" data-status="@booking.BookingStatus.ToLower()" data-booking-id="@booking.BookingId">
                    <div class="card-pattern"></div>
                    <div class="card-header">
                        <div class="card-logo">HRS SMART</div>
                        <div class="card-booking-badge">
                            <i class="bi bi-calendar-check"></i>
                            <span>BOOKING</span>
                        </div>
                    </div>
                    <div class="card-number">
                        @String.Format("{0:D4} {1} {2}", booking.BookingId, booking.RoomNumber.PadLeft(4, '0'), booking.CheckInDate.Replace("-", "").Substring(2))
                    </div>
                    <div class="card-details">
                        <div class="card-info">
                            <div class="card-label">ROOM TYPE</div>
                            <div class="card-value">@booking.RoomType</div>
                        </div>
                        <div class="card-info">
                            <div class="card-label">CHECK-IN</div>
                            <div class="card-value">@booking.CheckInDate</div>
                        </div>
                        <div class="card-info">
                            <div class="card-label">CHECK-OUT</div>
                            <div class="card-value">@booking.CheckOutDate</div>
                        </div>
                    </div>
                    <div class="card-details">
                        <div class="card-info">
                            <div class="card-label">GUESTS</div>
                            <div class="card-value">
                                <i class="bi bi-people"></i> @booking.NumberOfGuests
                            </div>
                        </div>
                        <div class="card-info">
                            <div class="card-label">TOTAL</div>
                            <div class="card-value card-total">@booking.TotalPrice</div>
                        </div>
                        <div class="card-info">
                            <div class="card-label">STATUS</div>
                            <div class="card-value status-badge-inline status-@booking.BookingStatus.ToLower()">@booking.BookingStatus</div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="card-room-key-section">
                            <div class="card-label">
                                <i class="bi bi-key"></i> ROOM KEY
                            </div>
                            <div class="card-key">@booking.RoomKey</div>
                        </div>
                        <div class="card-booking-id-section">
                            <div class="card-label">BOOKING ID</div>
                            <div class="card-booking-id">#@booking.BookingId</div>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button type="button" class="btn-card-download" onclick="downloadBooking('@booking.BookingId', '@booking.RoomType', '@booking.RoomNumber', '@booking.CheckInDate', '@booking.CheckOutDate', '@booking.TotalPrice', '@booking.RoomKey')">
                            <i class="bi bi-download"></i> Download Ticket
                        </button>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="empty-state glass-panel">
            <i class="bi bi-calendar-x"></i>
            <h3>No room bookings yet</h3>
            <p>You haven't made any room bookings. Start exploring our rooms!</p>
            <a asp-page="/Customer/Rooms" class="btn btn-gradient">Browse Rooms</a>
        </div>
    }

    <!-- Travel Bookings Section -->
    <div class="section-header mt-5">
        <div>
            <p class="eyebrow">Travel & Attractions</p>
            <h2>Your Travel Bookings</h2>
            <p>Manage your travel experiences and attraction bookings</p>
        </div>
    </div>

    @if (Model.TravelBookings.Any())
    {
        <div class="travel-bookings-grid">
            @foreach (var travelBooking in Model.TravelBookings)
            {
                <div class="travel-booking-card-display" data-status="@travelBooking.BookingStatus.ToLower()">
                    <div class="travel-booking-header">
                        <div class="travel-booking-badge">
                            <i class="bi bi-geo-alt"></i>
                            <span>@travelBooking.AttractionType.ToUpper()</span>
                        </div>
                        <span class="travel-booking-status status-@travelBooking.BookingStatus.ToLower()">
                            @travelBooking.BookingStatus
                        </span>
                    </div>
                    <div class="travel-booking-content">
                        <h3>@travelBooking.AttractionName</h3>
                        <div class="travel-booking-details">
                            <div class="travel-detail-item">
                                <i class="bi bi-calendar"></i>
                                <span>Travel Date: @travelBooking.TravelDate</span>
                            </div>
                            <div class="travel-detail-item">
                                <i class="bi bi-people"></i>
                                <span>Participants: @travelBooking.NumberOfParticipants</span>
                            </div>
                            <div class="travel-detail-item">
                                <i class="bi bi-currency-dollar"></i>
                                <span>Total: @travelBooking.TotalPrice</span>
                            </div>
                            <div class="travel-detail-item">
                                <i class="bi bi-credit-card"></i>
                                <span>Payment: @travelBooking.PaymentMethod (@travelBooking.PaymentStatus)</span>
                            </div>
                        </div>
                        @if (travelBooking.RefundRequested)
                        {
                            <div class="travel-refund-status">
                                @if (travelBooking.RefundApproved == true)
                                {
                                    <div class="alert alert-success mb-2">
                                        <i class="bi bi-check-circle"></i> Refund Approved
                                        @if (travelBooking.RefundProcessedAt.HasValue)
                                        {
                                            <small>Processed: @travelBooking.RefundProcessedAt.Value.ToString("MMM dd, yyyy")</small>
                                        }
                                    </div>
                                }
                                else if (travelBooking.RefundApproved == false)
                                {
                                    <div class="alert alert-danger mb-2">
                                        <i class="bi bi-x-circle"></i> Refund Request Denied
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-warning mb-2">
                                        <i class="bi bi-clock"></i> Refund Request Pending Approval
                                    </div>
                                }
                            </div>
                        }
                        <div class="travel-booking-actions">
                            @if (!travelBooking.RefundRequested && travelBooking.BookingStatus != "cancelled" && travelBooking.PaymentStatus == "paid")
                            {
                                <form method="post" asp-page-handler="RequestRefund" style="display: inline;">
                                    <input type="hidden" name="travelBookingId" value="@travelBooking.TravelBookingId" />
                                    <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Are you sure you want to request a refund? This will need approval.')">
                                        <i class="bi bi-arrow-counterclockwise"></i> Request Refund
                                    </button>
                                </form>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="empty-state glass-panel">
            <i class="bi bi-map"></i>
            <h3>No travel bookings yet</h3>
            <p>Explore Rwanda's amazing attractions and book your adventure!</p>
            <a asp-page="/Customer/Explore" class="btn btn-gradient">Explore Attractions</a>
        </div>
    }
</section>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        function downloadBooking(bookingId, roomType, roomNumber, checkIn, checkOut, totalPrice, roomKey) {
            console.log('Download button clicked for booking:', bookingId);
            
            // Wait for html2pdf library to load
            function waitForHtml2Pdf() {
                return new Promise((resolve, reject) => {
                    if (typeof html2pdf !== 'undefined') {
                        resolve();
                        return;
                    }
                    
                    let attempts = 0;
                    const maxAttempts = 100;
                    const checkInterval = setInterval(() => {
                        attempts++;
                        if (typeof html2pdf !== 'undefined') {
                            clearInterval(checkInterval);
                            resolve();
                        } else if (attempts >= maxAttempts) {
                            clearInterval(checkInterval);
                            reject(new Error('html2pdf library not available'));
                        }
                    }, 50);
                });
            }
            
            waitForHtml2Pdf().then(() => {
                downloadCardAsPDF(bookingId, roomType, roomNumber, checkIn, checkOut, totalPrice, roomKey);
            }).catch(error => {
                console.error('Library not ready:', error);
                alert('PDF library is not loaded. Please refresh the page and try again.');
            });
        }
        
        function downloadCardAsPDF(bookingId, roomType, roomNumber, checkIn, checkOut, totalPrice, roomKey) {
            console.log('Creating PDF for booking:', bookingId);
            
            // Create the card HTML structure without QR codes
            const cardHtml = `
                <div style="width: 85.6mm; height: 70mm; font-family: 'Arial', sans-serif; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; padding: 5mm; display: flex; flex-direction: column; justify-content: space-between; position: relative; overflow: hidden; box-sizing: border-box;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; opacity: 0.1; background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.1) 10px, rgba(255,255,255,0.1) 20px); pointer-events: none;"></div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3mm; z-index: 1;">
                        <div style="font-size: 9pt; font-weight: bold; letter-spacing: 1.5px;">HRS SMART</div>
                        <div style="font-size: 7pt; opacity: 0.9;">BOOKING TICKET</div>
                    </div>
                    <div style="font-size: 11pt; font-weight: bold; letter-spacing: 2.5px; margin: 3mm 0; z-index: 1; font-family: 'Courier New', monospace;">${String(bookingId).padStart(4, '0')} ${String(roomNumber).padStart(4, '0')} ${checkIn.replace(/-/g, '').substring(2)}</div>
                    <div style="display: flex; justify-content: space-between; font-size: 7pt; margin-bottom: 2mm; z-index: 1;">
                        <div style="flex: 1;">
                            <div style="font-size: 5pt; opacity: 0.8; margin-bottom: 0.5mm;">ROOM TYPE</div>
                            <div style="font-weight: bold; font-size: 7pt;">${roomType}</div>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 5pt; opacity: 0.8; margin-bottom: 0.5mm;">CHECK-IN</div>
                            <div style="font-weight: bold; font-size: 7pt;">${checkIn}</div>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 5pt; opacity: 0.8; margin-bottom: 0.5mm;">CHECK-OUT</div>
                            <div style="font-weight: bold; font-size: 7pt;">${checkOut}</div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 7pt; margin-bottom: 2mm; z-index: 1;">
                        <div style="flex: 1;">
                            <div style="font-size: 5pt; opacity: 0.8; margin-bottom: 0.5mm;">TOTAL</div>
                            <div style="font-weight: bold; font-size: 7pt;">${totalPrice}</div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: flex-end; z-index: 1;">
                        <div>
                            <div style="font-size: 5pt; opacity: 0.8; margin-bottom: 0.5mm;">ROOM KEY</div>
                            <div style="font-size: 8pt; font-weight: bold; letter-spacing: 1px; font-family: 'Courier New', monospace;">${roomKey}</div>
                        </div>
                        <div>
                            <div style="font-size: 5pt; opacity: 0.8; margin-bottom: 0.5mm;">BOOKING ID</div>
                            <div style="font-size: 8pt; font-weight: bold; font-family: 'Courier New', monospace;">#${bookingId}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Create a temporary container
            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px';
            tempContainer.style.top = '0';
            tempContainer.innerHTML = cardHtml;
            document.body.appendChild(tempContainer);
            
            const cardElement = tempContainer.firstElementChild;
            
            // Configure PDF options
            const opt = {
                margin: 0,
                filename: `booking-ticket-${bookingId}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    logging: false
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: [85.6, 70],
                    orientation: 'landscape'
                }
            };
            
            // Generate and download PDF
            html2pdf().set(opt).from(cardElement).save().then(() => {
                // Clean up
                document.body.removeChild(tempContainer);
                console.log('PDF downloaded successfully');
            }).catch(error => {
                console.error('Error generating PDF:', error);
                document.body.removeChild(tempContainer);
                alert('Error generating PDF. Please try again.');
            });
        }
    </script>
}

