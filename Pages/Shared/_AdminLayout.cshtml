@using System.Linq
@using HRS_SmartBooking.Services
@using HRS_SmartBooking.Helpers
@inject AuthService AuthService
@{
    var userFirstName = Context.Session.GetString("FirstName") ?? "System";
    var userLastName = Context.Session.GetString("LastName") ?? "Admin";
    var userRole = AuthService.GetCurrentUserRole() ?? "Administrator";
    var fullName = $"{userFirstName} {userLastName}".Trim();
    var initials = string.Concat(userFirstName.Take(1)).ToUpper() + string.Concat(userLastName.Take(1)).ToUpper();
    var currentPath = Context.Request.Path;
    var themePreference = Context.Session?.GetString("ThemePreference") ?? "light";
    var languagePreference = Context.Session?.GetString("PreferredLanguage") ?? "ENG";
    var htmlLang = languagePreference == "KIN" ? "rw" : "en";
    var lang = TranslationHelper.GetCurrentLanguage(Context);
    Func<string, string> isActive = path => currentPath.StartsWithSegments(path, StringComparison.OrdinalIgnoreCase) ? "active" : string.Empty;
}

<!DOCTYPE html>
<html lang="@htmlLang">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewData["Title"] - Admin | HRS Smart Booking</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" integrity="sha384-XGjxtQfXaH2tnPFa9x+ruJTuLE3Aa6LhHSWRr1XeTyhezb4abCG4ccI5AkVDxqC+" crossorigin="anonymous">
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/admin.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/HRS_SmartBooking.styles.css" asp-append-version="true" />
</head>
<body class="admin-shell theme-@themePreference">
    <aside class="admin-sidebar" id="adminSidebar">
        <div class="sidebar-brand">
            <div class="brand-mark">HRS</div>
            <div>
                <p class="brand-title mb-0">Smart Booking</p>
                <small class="text-muted">Operations Suite</small>
            </div>
        </div>

        <div class="sidebar-user">
            <div class="user-avatar">@initials</div>
            <div>
                <p class="user-name mb-0">@fullName</p>
                <small class="text-muted">@userRole</small>
            </div>
        </div>

        <nav class="sidebar-nav">
            <a class="sidebar-link @isActive("/Admin/Dashboard")" asp-page="/Admin/Dashboard">
                <i class="bi bi-speedometer2"></i>
                <span>@TranslationHelper.T("Dashboard", lang)</span>
            </a>
            <a class="sidebar-link @isActive("/Admin/UserManagement")" asp-page="/Admin/UserManagement">
                <i class="bi bi-people"></i>
                <span>@TranslationHelper.T("User Management", lang)</span>
            </a>
            <a class="sidebar-link @isActive("/Admin/RolesPermissions")" asp-page="/Admin/RolesPermissions">
                <i class="bi bi-shield-lock"></i>
                <span>@TranslationHelper.T("Roles & Permissions", lang)</span>
            </a>
            <a class="sidebar-link @isActive("/Admin/StaffManagement")" asp-page="/Admin/StaffManagement">
                <i class="bi bi-briefcase"></i>
                <span>@TranslationHelper.T("Staff Management", lang)</span>
            </a>
            <a class="sidebar-link @isActive("/Admin/SystemConfiguration")" asp-page="/Admin/SystemConfiguration">
                <i class="bi bi-gear"></i>
                <span>@TranslationHelper.T("System Configuration", lang)</span>
            </a>
            <a class="sidebar-link @isActive("/Admin/AuditLogs")" asp-page="/Admin/AuditLogs">
                <i class="bi bi-clipboard-data"></i>
                <span>@TranslationHelper.T("Audit Logs", lang)</span>
            </a>
            <a class="sidebar-link @isActive("/Manager/ManageTravelBookings")" asp-page="/Manager/ManageTravelBookings">
                <i class="bi bi-airplane"></i>
                <span>@TranslationHelper.T("Travel Bookings", lang)</span>
            </a>
            <a class="sidebar-link @isActive("/Admin/Payments")" asp-page="/Admin/Payments">
                <i class="bi bi-credit-card"></i>
                <span>@TranslationHelper.T("Payments & Transactions", lang)</span>
            </a>
            <a class="sidebar-link @isActive("/Admin/Reports")" asp-page="/Admin/Reports">
                <i class="bi bi-graph-up-arrow"></i>
                <span>@TranslationHelper.T("Reports", lang)</span>
            </a>
            <a class="sidebar-link @isActive("/Admin/DatabaseControl")" asp-page="/Admin/DatabaseControl">
                <i class="bi bi-hdd-stack"></i>
                <span>@TranslationHelper.T("Database Control", lang)</span>
            </a>
            <a class="sidebar-link @isActive("/Admin/BackupRestore")" asp-page="/Admin/BackupRestore">
                <i class="bi bi-cloud-arrow-up"></i>
                <span>@TranslationHelper.T("Backup & Restore", lang)</span>
            </a>
            <a class="sidebar-link @isActive("/Admin/SecurityCenter")" asp-page="/Admin/SecurityCenter">
                <i class="bi bi-shield-check"></i>
                <span>@TranslationHelper.T("Security Center", lang)</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <form method="post" asp-page="/Logout" class="w-100">
                <button type="submit" class="btn sidebar-logout w-100 d-inline-flex align-items-center justify-content-center gap-2">
                    <i class="bi bi-box-arrow-right"></i>
                    @TranslationHelper.T("Logout", lang)
                </button>
            </form>
        </div>
    </aside>

    <div class="admin-main">
        <header class="admin-topbar">
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-outline-secondary d-lg-none" id="sidebarToggle" type="button">
                    <i class="bi bi-list"></i>
                </button>
                <div>
                    <p class="topbar-title mb-0">@ViewData["Title"]</p>
                    <small class="text-muted">Control center â€¢ Updated @DateTime.Now.ToString("t")</small>
                </div>
            </div>
            <div class="topbar-actions">
                <div class="topbar-search">
                    <i class="bi bi-search"></i>
                    <input type="search" class="form-control" placeholder="Quick search" />
                </div>
                <form method="post" asp-page="/Preferences/Update" asp-page-handler="Theme" class="d-inline">
                    <input type="hidden" name="mode" value="@(themePreference == "dark" ? "light" : "dark")" />
                    <button class="btn btn-icon" type="submit" title="Toggle theme">
                        <i class="bi @(themePreference == "dark" ? "bi-sun" : "bi-moon")"></i>
                    </button>
                </form>
                <form method="post" asp-page="/Preferences/Update" asp-page-handler="Language" class="d-inline">
                    <input type="hidden" name="locale" value="@(languagePreference == "KIN" ? "ENG" : "KIN")" />
                    <button class="btn btn-icon" type="submit" title="Toggle language">
                        <i class="bi bi-translate"></i>
                    </button>
                </form>
                <button class="btn btn-icon" data-bs-toggle="modal" data-bs-target="#notificationModal" title="Notifications">
                    <i class="bi bi-bell"></i>
                    <span class="dot"></span>
                </button>
            </div>
        </header>

        <main class="admin-content">
            @RenderBody()
        </main>
    </div>

    <!-- Notification Settings Modal -->
    <div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="notificationModalLabel">@TranslationHelper.T("Notification Settings", lang)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="notificationForm">
                        <div class="notification-category mb-4">
                            <h6 class="mb-3">
                                <i class="bi bi-box-arrow-in-right me-2"></i>
                                @TranslationHelper.T("Login Notifications", lang)
                            </h6>
                            <div class="notification-item">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>Email notifications for login attempts</span>
                                    <label class="switch">
                                        <input type="checkbox" checked name="login_email" />
                                        <span></span>
                                    </label>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>SMS notifications for new device login</span>
                                    <label class="switch">
                                        <input type="checkbox" name="login_sms" />
                                        <span></span>
                                    </label>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>Push notifications for failed login attempts</span>
                                    <label class="switch">
                                        <input type="checkbox" checked name="login_push" />
                                        <span></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="notification-category mb-4">
                            <h6 class="mb-3">
                                <i class="bi bi-credit-card me-2"></i>
                                @TranslationHelper.T("Payment Notifications", lang)
                            </h6>
                            <div class="notification-item">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>Email notifications for successful payments</span>
                                    <label class="switch">
                                        <input type="checkbox" checked name="payment_email" />
                                        <span></span>
                                    </label>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>SMS notifications for payment failures</span>
                                    <label class="switch">
                                        <input type="checkbox" checked name="payment_sms" />
                                        <span></span>
                                    </label>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>Push notifications for refunds</span>
                                    <label class="switch">
                                        <input type="checkbox" name="payment_push" />
                                        <span></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="notification-category mb-4">
                            <h6 class="mb-3">
                                <i class="bi bi-door-open me-2"></i>
                                @TranslationHelper.T("Room Notifications", lang)
                            </h6>
                            <div class="notification-item">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>Email notifications for room availability</span>
                                    <label class="switch">
                                        <input type="checkbox" checked name="room_email" />
                                        <span></span>
                                    </label>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>SMS notifications for room maintenance</span>
                                    <label class="switch">
                                        <input type="checkbox" name="room_sms" />
                                        <span></span>
                                    </label>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>Push notifications for room status changes</span>
                                    <label class="switch">
                                        <input type="checkbox" checked name="room_push" />
                                        <span></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="notification-category mb-4">
                            <h6 class="mb-3">
                                <i class="bi bi-calendar-check me-2"></i>
                                @TranslationHelper.T("Booking Notifications", lang)
                            </h6>
                            <div class="notification-item">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>Email notifications for new bookings</span>
                                    <label class="switch">
                                        <input type="checkbox" checked name="booking_email" />
                                        <span></span>
                                    </label>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>SMS notifications for booking confirmations</span>
                                    <label class="switch">
                                        <input type="checkbox" checked name="booking_sms" />
                                        <span></span>
                                    </label>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>Push notifications for booking cancellations</span>
                                    <label class="switch">
                                        <input type="checkbox" name="booking_push" />
                                        <span></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="notification-category mb-4">
                            <h6 class="mb-3">
                                <i class="bi bi-gear me-2"></i>
                                @TranslationHelper.T("System Notifications", lang)
                            </h6>
                            <div class="notification-item">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>Email notifications for system updates</span>
                                    <label class="switch">
                                        <input type="checkbox" checked name="system_email" />
                                        <span></span>
                                    </label>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>SMS notifications for security alerts</span>
                                    <label class="switch">
                                        <input type="checkbox" checked name="system_sms" />
                                        <span></span>
                                    </label>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>Push notifications for maintenance windows</span>
                                    <label class="switch">
                                        <input type="checkbox" name="system_push" />
                                        <span></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-light" onclick="acceptAllNotifications()">@TranslationHelper.T("Accept All", lang)</button>
                    <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">@TranslationHelper.T("Cancel", lang)</button>
                    <button type="button" class="btn btn-gradient" onclick="updateAllNotifications()">@TranslationHelper.T("Update All", lang)</button>
                </div>
            </div>
        </div>
    </div>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (function () {
            const sidebar = document.getElementById('adminSidebar');
            const toggle = document.getElementById('sidebarToggle');
            if (!sidebar || !toggle) return;
            toggle.addEventListener('click', function () {
                sidebar.classList.toggle('open');
            });
        })();

        function acceptAllNotifications() {
            const form = document.getElementById('notificationForm');
            const checkboxes = form.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
        }

        function updateAllNotifications() {
            const form = document.getElementById('notificationForm');
            const formData = new FormData(form);
            // Here you would send the data to the server
            console.log('Updating notification preferences...', Object.fromEntries(formData));
            // Close modal after update
            const modal = bootstrap.Modal.getInstance(document.getElementById('notificationModal'));
            modal.hide();
            // Show success message
            alert('Notification preferences updated successfully!');
        }
    </script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>

